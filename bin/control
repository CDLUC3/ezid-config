#! /bin/bash

USAGE="Usage: $0 start|stop|force-stop|restart|force-restart|status"
APACHECTL=/ezid/apache/bin/apachectl
WGET=/usr/bin/wget
PR=/ezid/apache/ezid/SITE/PROJECT
SHADOWFILE=$PR/settings/ezid.conf.shadow
CLIENT=$PR/tools/client

. /ezid/apache/WARTS/env.sh

if [ $# -ne 1 ]; then
    echo $USAGE
    exit 1
fi

function pauseEzid {
    pidcount=`ps -fU ezid | grep -c '[h]ttpd'`
    if [ $pidcount -eq 0 ]; then
       echo "Pausing the server... (doesn't appear to be running)"
       return
    fi
    level=${DJANGO_SETTINGS_MODULE#*.}
    # The parsing below is far from foolproof, but we do at least look
    # for a deployment-level-specific value before a generic value.
    password=`grep '^{'$level'}admin_password: [^ ]' $SHADOWFILE`
    if [ "$password" == "" ]; then
        password=`grep '^admin_password: [^ ]' $SHADOWFILE`
        if [ "$password" == "" ]; then
            echo "ERROR: unable to locate admin password" 1>&2
            exit 1
        fi
    fi
    password=${password#*: }
    echo "Pausing the server..."
    $CLIENT ${level:0:1} "admin:$password" pause idlewait
    if [ $? -ne 0 ]; then
        echo "ERROR: server 'pause idlewait' command failed" 1>&2
        exit 1
    fi
}

function execExerciseEzid {
  # The various components of EZID are loaded on demand.  The
  # following request does not cause everything to be loaded and
  # tested, but it does confirm that Apache, mod_wsgi, Django, and
  # EZID are basically functioning.
  echo "Exercising the server..."
  exec $WGET -q -T 60 -t 1 -O /dev/null http://$HOSTNAME/status
}

case $1 in
    start)
        pid=`ps -fU ezid | grep '[d]ownserver' | head -1 | awk '{ print $2 }'`
        if [ "$pid" != "" ]; then
            echo
            echo "!!! The downserver might be running; see PID $pid"
            echo
        fi
        echo "Starting the server..."
        $APACHECTL start
        status=$?
        if [ $status -ne 0 ]; then exit $status; fi
        execExerciseEzid
        ;;
    stop)
        pauseEzid
        ;&
    force-stop)
        echo "Stopping the server..."
        exec $APACHECTL stop
        ;;
    restart)
        pauseEzid
        ;&
    force-restart)
        echo "Restarting the server..."
        $APACHECTL restart
        status=$?
        if [ $status -ne 0 ]; then exit $status; fi
        execExerciseEzid
        ;;
    status)
        pidcount=`ps -fU ezid | grep -c '[h]ttpd'`
        if [ $pidcount -gt 0 ]; then
            # The server appears to be running; check that it's
            # responsive.
            $WGET -q -T 60 -t 1 -O /dev/null http://$HOSTNAME/status
            status=$?
            if [ $status -eq 0 ]; then
                echo "up"
                exit 0
            else
                # Not responsive.  Is it an EZID problem or a
                # network/DNS problem?  Try connecting to another
                # CDL production service.
                $WGET -q -T 10 -t 1 -O /dev/null http://n2t.net/
                status=$?
                if [ $status -eq 0 ]; then
                    # It appears to be EZID's problem.
                    echo "down (unresponsive)"
                    exit 1
                else
                    echo "up (maybe; there appear to be network problems)"
                    exit 0
                fi
            fi
        else
            echo "down (not running)"
            exit 1
        fi
        ;;
    *)
        echo $USAGE
        exit 1
        ;;
esac
