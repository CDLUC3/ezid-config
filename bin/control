#! /bin/bash

USAGE="Usage: $0 start|stop|restart|status"
APACHECTL=/n2t/apache/bin/apachectl
WGET=/cdlcommon/products/bin/wget
SENTINEL=/n2t/init.d/VCS_MONITOR_DISABLED

. /n2t/apache/WARTS/env.sh

if [ $# -ne 1 ]; then
    echo $USAGE
    exit 1
fi

case $1 in
    start)
        pid=`ps -fU n2t | grep '[d]ownserver' | awk '{ print $2 }'`
        if [ "$pid" != "" ]; then
            echo
            echo "!!! The downserver might be running; see PID $pid"
            echo
        fi
        exec $APACHECTL start
        ;;
    stop)
        exec $APACHECTL stop
        ;;
    restart)
        exec $APACHECTL restart
        ;;
    status)
        if [ -f $SENTINEL ]; then
            # Fake out VCS.
            echo "up (by virtue of VCS fakeout)"
            exit 0
        else
            pidcount=`ps -fU n2t | grep -c '[h]ttpd'`
            if [ $pidcount -gt 0 ]; then
                # The server appears to be running; check that it's
                # responsive.
                $WGET -q -T 60 -t 1 -O /dev/null http://$HOSTNAME/ezid/status
                status=$?
                if [ $status -eq 0 ]; then
                    echo "up"
                    exit 0
                else
                    # Not responsive.  Is it an EZID problem or a
                    # network/DNS problem?  Try connecting to another
                    # CDL production service.
                    $WGET -q -T 10 -t 1 -O /dev/null http://www.cdlib.org/
                    status=$?
                    if [ $status -eq 0 ]; then
                        # It appears to be EZID's problem.
                        echo "down (unresponsive)"
                        exit 1
                    else
                        echo "up (maybe; there appear to be network problems)"
                        exit 0
                    fi
                fi
            else
                echo "down (not running)"
                exit 1
            fi
        fi
        ;;
    *)
        echo $USAGE
        exit 1
        ;;
esac
